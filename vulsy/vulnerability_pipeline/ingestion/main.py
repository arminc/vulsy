"""Main entry point for the ingestion process."""

import logging
from functools import partial

import typer

from vulsy import tracer
from vulsy.common.couchbase_storage.repo.ingestion import IngestionDataRepositoryImpl
from vulsy.settings import settings
from vulsy.vulnerability_pipeline.ingestion.ingest import ingest
from vulsy.vulnerability_pipeline.ingestion.names import SourceName
from vulsy.vulnerability_pipeline.ingestion.sources import nvd as nvd_source

ingestion_app = typer.Typer()


@ingestion_app.command()
@tracer.start_as_current_span("ingest_nvd")
def nvd() -> None:
    """Ingest NVD data."""
    logging.getLogger().info("Ingest NVD data...")
    ingest(
        SourceName.NVD,
        IngestionDataRepositoryImpl(),
        nvd_source.get_initial_endpoints_changed_list,
        partial(nvd_source.get_rawdata, headers={"apiKey": settings.sources.nvd_api_key}),
    )
    logging.getLogger().info("NVD data ingested.")
